#!/bin/bash


if ! options=$(getopt -o '' --long local,new,ws:,http: -- "$@")
then
    echo "Usage: up [--new][--ws <port>][--http <port>]

    --new : Initialize DAG program
    --ws : Define Websocket server port
    --http : Define HTTP-RPC server port
    "
    exit 1
fi
printf " * Current Working Directory is %s $(pwd)\n"

export FLASK_APP=dagapi

eval set -- "$options"
while true; do
    case "$1" in
        --local)
            LOCAL="true"
            shift ;;
        --new)
            NEW="true"
            shift ;;
        --ws)
            P2P_PORT=$2
            shift 2 ;;
        --http)
            HTTP_PORT=$2
            shift 2 ;;
        --)
            source ./script/set_port --http $HTTP_PORT
            shift
            break ;;
    esac
done


if [[ $NEW == "true" ]] ; then
    echo "one"|./script/reset_client
    echo >&2 "Start RDB(SQLite3)"
    flask init-db
fi

# python ./p2p_srv.py --port $P2P_PORT &
# flask run -p $HTTP_PORT &
if [[ $LOCAL == "true" ]]; then
    echo " * Open as localhost"
    flask run -p $HTTP_PORT
else
    echo " * Open as product server"
    flask run --host=0.0.0.0 -p $HTTP_PORT
fi

echo " * Initialize KU-DAG"
